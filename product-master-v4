<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Product Master</title>

<style>
body{font-family:Arial;background:#f4f5f7;margin:0}
header{background:#fff;padding:16px 20px;border-bottom:1px solid #ddd;font-size:20px;font-weight:600}

.container{display:flex;gap:20px;padding:20px}
.left{width:360px;background:#fff;padding:16px;border-radius:10px}
.right{flex:1;background:#fff;padding:16px;border-radius:10px}

input,textarea{
  width:100%;
  padding:9px;
  margin:6px 0 12px;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:14px
}

button{
  padding:10px;
  background:#000;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px
}

.top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px
}
.search{width:60%}

.products{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:14px
}

.product{
  display:flex;
  gap:12px;
  padding:12px;
  border:1px solid #e5e5e5;
  border-radius:10px
}
.product img{
  width:70px;height:90px;
  object-fit:cover;
  border-radius:6px;
  background:#eee
}

.product small{display:block;color:#555;font-size:12px}

.stock{font-weight:600;margin-top:4px}
.stock.ok{color:#2e7d32}
.stock.low{color:#c62828}

.edit-box{
  margin-top:8px;
  display:none;
  gap:6px
}
.edit-box input{
  width:80px;
  padding:6px;
  margin:0
}
.edit-actions{
  display:flex;
  gap:6px;
  margin-top:6px
}
</style>
</head>

<body>

<header>PRODUCT MASTER</header>

<div class="container">

  <!-- ADD PRODUCT -->
  <div class="left">
    <h3>Add Product</h3>

    <input id="pCode" placeholder="Product Code">
    <input id="pName" placeholder="Product Name">
    <textarea id="pDesc" placeholder="Description"></textarea>
    <input id="pSizes" placeholder="Sizes (M,L,XL)">
    <input id="pPrice" placeholder="Price per PC">
    <input id="pGST" placeholder="GST %">
    <input id="pStock" placeholder="Master Stock (sets)">
    <input id="pImages" placeholder="Image URLs (comma separated)">

    <button onclick="addProduct()">Save Product</button>
  </div>

  <!-- ALL PRODUCTS -->
  <div class="right">
    <div class="top">
      <b>All Products</b>
      <input id="search" class="search" placeholder="Search" oninput="render()">
    </div>

    <div id="list" class="products">Loading products…</div>
  </div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";
const SUPPLIER_ID="SUP001";

let products=[];

/* ---------------- ADD PRODUCT ---------------- */
function addProduct(){
  if(!pCode.value || !pName.value || !pStock.value){
    alert("Product Code, Name & Master Stock are required");
    return;
  }

  fetch(`${API}?action=addProduct`
    +`&supplierId=${SUPPLIER_ID}`
    +`&productCode=${encodeURIComponent(pCode.value)}`
    +`&productName=${encodeURIComponent(pName.value)}`
    +`&description=${encodeURIComponent(pDesc.value)}`
    +`&sizesJSON=${encodeURIComponent(JSON.stringify(pSizes.value.split(",").map(s=>s.trim())))}` 
    +`&pricePerPC=${pPrice.value}`
    +`&gstPercent=${pGST.value}`
    +`&imageURLsJSON=${encodeURIComponent(JSON.stringify(pImages.value.split(",").map(i=>i.trim())))}` 
    +`&masterStock=${pStock.value}`
  )
  .then(r=>r.json())
  .then(j=>{
    if(j.status!=="success"){ alert(j.message); return; }
    clearForm();
    loadProducts();
  });
}

function clearForm(){
  pCode.value=pName.value=pDesc.value=pSizes.value=pPrice.value=pGST.value=pStock.value=pImages.value="";
}

/* ---------------- LOAD PRODUCTS ---------------- */
function loadProducts(){
  fetch(`${API}?action=getProductsBySupplier&supplierId=${SUPPLIER_ID}`)
    .then(r=>r.json())
    .then(j=>{
      products = (j.data || [])
        .sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
      render();
    });
}

/* ---------------- RENDER ---------------- */
function render(){
  const q = search.value.toLowerCase();
  list.innerHTML="";

  const filtered = products.filter(p=>
    String(p.productCode).toLowerCase().includes(q) ||
    String(p.productName).toLowerCase().includes(q)
  );

  if(!filtered.length){
    list.innerHTML="<div style='color:#777'>No products</div>";
    return;
  }

  filtered.forEach(p=>{
    const stock = Number(p.MASTER_STOCK || 0);
    const stockClass = stock>0 ? "ok" : "low";

    list.innerHTML += `
      <div class="product">
        <img src="${p.imageURLs?.[0] || ""}">
        <div style="flex:1">
          <b>${p.productCode}</b>
          <small>${p.productName}</small>
          <small>Sizes: ${p.sizes.join(", ")}</small>
          <small>₹${p.pricePerPC}</small>

          <div class="stock ${stockClass}">
            Godown Stock: <span id="stockText-${p.productCode}">${stock}</span> sets
          </div>

          <div class="edit-actions">
            <button onclick="openEdit('${p.productCode}', ${stock})">Edit</button>
          </div>

          <div class="edit-box" id="edit-${p.productCode}">
            <input id="editStock-${p.productCode}" type="number" min="0" value="${stock}">
            <button onclick="saveStock('${p.productCode}')">Save</button>
            <button onclick="cancelEdit('${p.productCode}')">Cancel</button>
          </div>
        </div>
      </div>`;
  });
}

/* ---------------- EDIT FLOW ---------------- */
function openEdit(code){
  document.getElementById(`edit-${code}`).style.display="flex";
}

function cancelEdit(code){
  document.getElementById(`edit-${code}`).style.display="none";
}

function saveStock(code){
  const val = Number(document.getElementById(`editStock-${code}`).value);
  if(isNaN(val)||val<0){
    alert("Invalid stock value");
    return;
  }

  fetch(`${API}?action=updateMasterStock&productCode=${code}&masterStock=${val}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){ alert(j.message); return; }
      loadProducts();
    });
}

/* INIT */
loadProducts();
</script>

</body>
</html>
