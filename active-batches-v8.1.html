<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Supplier ‚Äì Active Batches</title>

<style>
body{font-family:Arial;background:#f4f5f7;margin:0}
header{background:#fff;padding:14px 18px;font-size:18px;font-weight:600;border-bottom:1px solid #ddd}
.batch{background:#fff;margin:14px;border-radius:8px;border:1px solid #ddd}
.batch h3{
  margin:0;padding:12px 16px;background:#fafafa;
  border-bottom:1px solid #eee;
  display:flex;justify-content:space-between;align-items:flex-start
}

.closeWrap{display:flex;flex-direction:column;align-items:flex-end}
.closeMsg{margin-top:4px;font-size:12px;color:#c0392b;font-weight:600}

.row{
  display:grid;
  grid-template-columns:70px 1.6fr 80px 90px 90px 90px 90px 80px;
  padding:10px 16px;border-top:1px solid #eee;align-items:center;font-size:13px
}
.row.head{font-weight:bold;background:#f9f9f9}

.row img{width:55px;height:55px;object-fit:cover;border-radius:6px;border:1px solid #ddd}

.green{color:#1e8f39;font-weight:bold}
.red{color:#c0392b;font-weight:bold}
.yellow{color:#f39c12;font-weight:bold}

button{padding:4px 8px;border:1px solid #aaa;background:#fff;cursor:pointer}
button:hover{background:#eee}
button[disabled]{background:#eee;color:#aaa;cursor:not-allowed}

.buyerBox{
  background:#fafafa;margin:8px 16px 12px 16px;
  border:1px solid #ddd;border-radius:6px
}

.buyerRow{
  display:grid;
  grid-template-columns:120px 90px 90px 90px 240px;
  padding:6px 10px;font-size:12px;border-top:1px solid #eee;align-items:center
}
.buyerRow.head{font-weight:bold;background:#eee}

input.qty{width:60px;padding:3px}
</style>
</head>

<body>

<header>Active Batches</header>
<div id="batches"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";

let supplierId=localStorage.getItem("supplierId");
if(!supplierId){
  supplierId=prompt("Enter Supplier ID");
  localStorage.setItem("supplierId",supplierId);
}

const batchOpenMap = {};   // üî• NEW: tracks OPEN buyers per batch

function load(){
fetch(API+"?action=getSupplierActiveBatches&supplierId="+supplierId)
.then(r=>r.json())
.then(data=>{
  const wrap=document.getElementById("batches");
  wrap.innerHTML="";
  Object.keys(batchOpenMap).forEach(k=>delete batchOpenMap[k]);

  data.forEach(b=>{
    batchOpenMap[b.batchId] = 0;   // initialize

    const block=document.createElement("div");
    block.className="batch";
    block.id="batch-"+b.batchId;

    block.innerHTML=`
      <h3>
        <span>Batch ${b.batchId}</span>
        <span class="closeWrap" id="close-${b.batchId}">
          <button disabled>Close Batch</button>
          <div class="closeMsg">Checking buyer approvals‚Ä¶</div>
        </span>
      </h3>

      <div class="row head">
        <div>Img</div><div>Product</div><div>Godown</div>
        <div>Locked</div><div>This Batch</div><div>Reserved</div><div>Sellable</div><div>Edit</div>
      </div>
    `;

    b.items.forEach(i=>{
      let cls=i.availableSets==0?"red":(i.availableSets<5?"yellow":"green");

      block.innerHTML+=`
      <div class="row">
        <div><img src="${i.image||'https://via.placeholder.com/55'}"></div>
        <div><b>${i.productCode}</b><br>${i.productName}</div>
        <div>${i.godown}</div>
        <div>${i.allocatedAll}</div>
        <div>${i.totalSets}</div>
        <div>${i.reservedSets}</div>
        <div class="${cls}">${i.availableSets}</div>
        <div>
          <button onclick="editStock('${b.batchId}','${i.productCode}',${i.availableSets},${i.reservedSets})">‚úèÔ∏è</button>
        </div>
      </div>
      <div id="buyers-${b.batchId}-${i.productCode}"></div>
      `;

      loadBuyers(b.batchId,i.productCode);
    });

    wrap.appendChild(block);
  });
});
}

function updateCloseButton(batchId){
  const wrap=document.getElementById("close-"+batchId);
  if(!wrap) return;

  if(batchOpenMap[batchId] > 0){
    wrap.innerHTML=`
      <button disabled>Close Batch</button>
      <div class="closeMsg">Please approve or reject all buyer requests to close this batch.</div>
    `;
  }else{
    wrap.innerHTML=`<button onclick="closeBatch('${batchId}',false)">Close Batch</button>`;
  }
}

function loadBuyers(batch,code){
 fetch(API+`?action=getReservationsForBatchProduct&batchId=${batch}&productCode=${code}`)
 .then(r=>r.json())
 .then(res=>{
  if(res.status!=="success") return;
  const div=document.getElementById(`buyers-${batch}-${code}`);
  if(res.data.length===0){ div.innerHTML=""; updateCloseButton(batch); return; }

  let h=`<div class="buyerBox">
    <div class="buyerRow head">
      <div>Buyer</div><div>Requested</div><div>Approved</div><div>Status</div><div>Action</div>
    </div>`;

  res.data.forEach(b=>{
    if(b.status==="OPEN") batchOpenMap[batch]++;

    h+=`
    <div class="buyerRow">
      <div>${b.buyerId}</div>
      <div>${b.requestedSets}</div>
      <div><input class="qty" id="qty-${b.basketId}-${code}" value="${b.approvedSets}"></div>
      <div>${b.status}</div>
      <div>
        <button onclick="updateQty('${b.basketId}','${batch}','${code}')">Update</button>
        <button onclick="approve('${b.basketId}')">Approve</button>
        <button onclick="reject('${b.basketId}','${batch}','${code}')">Reject</button>
      </div>
    </div>`;
  });

  div.innerHTML=h+"</div>";
  updateCloseButton(batch);
 });
}

/* existing functions unchanged */
function editStock(batch,code,avail,res){...}
function updateQty(...) { ... }
function approve(id){ ... }
function reject(...) { ... }
function closeBatch(id){ ... }

load();
</script>

</body>
</html>
