<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Product Master</title>

<style>
body{
  font-family:Arial, sans-serif;
  background:#f5f6f8;
  margin:0;
}
header{
  background:#fff;
  padding:16px 20px;
  border-bottom:1px solid #ddd;
  font-size:18px;
  font-weight:bold;
}
.container{
  display:flex;
  gap:20px;
  padding:20px;
}
.left{
  width:340px;
  background:#fff;
  padding:16px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
}
.right{
  flex:1;
  background:#fff;
  padding:16px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
}
h3{margin-top:0}
input,textarea,select{
  width:100%;
  padding:8px;
  margin:6px 0 12px;
  border:1px solid #ccc;
  border-radius:4px;
}
button{
  padding:10px;
  background:#000;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  width:100%;
}
button.secondary{
  background:#555;
  margin-top:6px;
}
.top{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:12px;
}
.search{
  flex:1;
}

/* PRODUCT CARD */
.product{
  display:flex;
  align-items:center;
  gap:14px;
  padding:12px;
  border:1px solid #eee;
  border-radius:8px;
  margin-bottom:10px;
}
.product img{
  width:70px;
  height:90px;
  object-fit:cover;
  border-radius:6px;
  background:#eee;
}
.info{
  flex:1;
}
.info b{
  font-size:14px;
}
.info small{
  color:#555;
  display:block;
  margin-top:2px;
}
.actions{
  width:90px;
}
.actions button{
  width:100%;
  padding:8px;
  font-size:13px;
}
.empty{
  color:#777;
  margin-top:20px;
}
.stock{
  font-weight:bold;
}
.stock.low{color:#c62828}
.stock.ok{color:#2e7d32}
</style>
</head>

<body>

<header>PRODUCT MASTER</header>

<div class="container">

  <!-- ADD / EDIT PRODUCT -->
  <div class="left">
    <h3 id="formTitle">Add Product</h3>

    <input id="pCode" placeholder="Product Code">
    <input id="pName" placeholder="Product Name">
    <textarea id="pDesc" placeholder="Description"></textarea>
    <input id="pSizes" placeholder="Sizes (M,L,XL)">
    <input id="pPrice" placeholder="Price per PC">
    <input id="pGST" placeholder="GST %">
    <input id="pImages" placeholder="Image URLs (comma separated)">

    <button onclick="saveProduct()" id="saveBtn">Save Product</button>
    <button class="secondary" onclick="resetForm()" id="cancelBtn" style="display:none">
      Cancel Edit
    </button>
  </div>

  <!-- ALL PRODUCTS -->
  <div class="right">
    <div class="top">
      <b>All Products</b>

      <select id="sort" onchange="render()">
        <option value="latest">Latest Added</option>
        <option value="stockDesc">Stock: High → Low</option>
        <option value="priceAsc">Price: Low → High</option>
        <option value="priceDesc">Price: High → Low</option>
        <option value="nameAsc">Name: A → Z</option>
      </select>

      <input id="search" class="search" placeholder="Search" oninput="render()">
    </div>

    <div id="list">Loading products…</div>
  </div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";
const SUPPLIER_ID="SUP001";

let products=[];
let editingProduct=null;

/* SAVE / UPDATE PRODUCT */
function saveProduct(){
  if(!pCode.value || !pName.value){
    alert("Product Code & Name required");
    return;
  }

  const params =
    `&supplierId=${encodeURIComponent(SUPPLIER_ID)}` +
    `&productCode=${encodeURIComponent(pCode.value)}` +
    `&productName=${encodeURIComponent(pName.value)}` +
    `&description=${encodeURIComponent(pDesc.value)}` +
    `&sizesJSON=${encodeURIComponent(JSON.stringify(pSizes.value.split(",").map(s=>s.trim())))}` +
    `&pricePerPC=${encodeURIComponent(pPrice.value)}` +
    `&gstPercent=${encodeURIComponent(pGST.value)}` +
    `&imageURLsJSON=${encodeURIComponent(JSON.stringify(pImages.value.split(",").map(i=>i.trim())))}`;

  const action = editingProduct ? "updateProduct" : "addProduct";

  fetch(`${API}?action=${action}${params}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){
        alert(j.message || "Error");
        return;
      }
      resetForm();
      loadProducts();
    });
}

/* LOAD PRODUCTS */
function loadProducts(){
  fetch(`${API}?action=getProductsBySupplier&supplierId=${SUPPLIER_ID}&_ts=${Date.now()}`)
    .then(r=>r.json())
    .then(j=>{
      products=j.data||[];
      render();
    });
}

/* RENDER */
function render(){
  const q = search.value.toLowerCase();
  const sort = document.getElementById("sort").value;

  let listData = products.filter(p =>
    String(p.productCode).toLowerCase().includes(q) ||
    String(p.productName).toLowerCase().includes(q)
  );

  if(sort==="priceAsc"){
    listData.sort((a,b)=>a.pricePerPC-b.pricePerPC);
  }
  else if(sort==="priceDesc"){
    listData.sort((a,b)=>b.pricePerPC-a.pricePerPC);
  }
  else if(sort==="nameAsc"){
    listData.sort((a,b)=>a.productName.localeCompare(b.productName));
  }
  else if(sort==="stockDesc"){
    listData.sort((a,b)=>b.availableStock-a.availableStock);
  }
  // latest already sorted by backend

  list.innerHTML="";
  if(!listData.length){
    list.innerHTML="<div class='empty'>No products</div>";
    return;
  }

  listData.forEach(p=>{
    const stockClass = p.availableStock > 0 ? "ok" : "low";

    list.innerHTML+=`
      <div class="product">
        <img src="${p.imageURLs?.[0] || ""}">
        <div class="info">
          <b>${p.productCode}</b>
          <small>${p.productName}</small>
          <small>Sizes: ${p.sizes.join(", ")}</small>
          <small>₹${p.pricePerPC}</small>
          <small class="stock ${stockClass}">
            Available: ${p.availableStock} sets
          </small>
        </div>
        <div class="actions">
          <button onclick='editProduct(${JSON.stringify(p)})'>Edit</button>
        </div>
      </div>
    `;
  });
}

/* EDIT */
function editProduct(p){
  editingProduct=p;
  formTitle.innerText="Edit Product";
  saveBtn.innerText="Update Product";
  cancelBtn.style.display="block";

  pCode.value=p.productCode;
  pCode.disabled=true;
  pName.value=p.productName;
  pDesc.value=p.description;
  pSizes.value=p.sizes.join(",");
  pPrice.value=p.pricePerPC;
  pGST.value=p.gstPercent;
  pImages.value=(p.imageURLs||[]).join(",");
}

/* RESET */
function resetForm(){
  editingProduct=null;
  formTitle.innerText="Add Product";
  saveBtn.innerText="Save Product";
  cancelBtn.style.display="none";
  pCode.disabled=false;

  pCode.value="";
  pName.value="";
  pDesc.value="";
  pSizes.value="";
  pPrice.value="";
  pGST.value="";
  pImages.value="";
}

/* INIT */
loadProducts();
</script>

</body>
</html>
