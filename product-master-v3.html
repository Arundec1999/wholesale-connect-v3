<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Product Master</title>

<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
header{background:#fff;padding:14px;border-bottom:1px solid #ddd;font-size:18px;font-weight:bold}
.container{display:flex;gap:20px;padding:16px}
.left{width:340px;background:#fff;padding:16px;border-radius:8px}
.right{flex:1;background:#fff;padding:16px;border-radius:8px}
input,textarea{width:100%;padding:8px;margin:6px 0 12px;border:1px solid #ccc;border-radius:4px}
button{padding:10px;background:#000;color:#fff;border:none;border-radius:4px;cursor:pointer;width:100%}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.search{width:60%}
.product{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #eee}
.product img{width:60px;height:80px;object-fit:cover;background:#e0f7fa}
small{color:#555}
.edit{padding:6px 10px;background:#000;color:#fff;border:none;border-radius:4px}
.empty{color:#777;margin-top:20px}
.error{color:#b00020;margin-top:20px}
</style>
</head>

<body>

<header>PRODUCT MASTER</header>

<div class="container">

  <!-- ADD PRODUCT -->
  <div class="left">
    <h3>Add Product</h3>
    <input id="pCode" placeholder="Product Code">
    <input id="pName" placeholder="Product Name">
    <textarea id="pDesc" placeholder="Description"></textarea>
    <input id="pSizes" placeholder="Sizes (M,L,XL)">
    <input id="pPrice" placeholder="Price per PC">
    <input id="pGST" placeholder="GST %">
    <input id="pImages" placeholder="Image URLs (comma separated)">
    <button onclick="addProduct()">Save Product</button>
  </div>

  <!-- ALL PRODUCTS -->
  <div class="right">
    <div class="top">
      <b>ALL Products</b>
      <input id="search" class="search" placeholder="Search" oninput="render()">
    </div>
    <div id="list">Loading products…</div>
  </div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";
const SUPPLIER_ID="SUP001";
let products=[];

/* ADD PRODUCT */
function addProduct(){
  if(!pCode.value||!pName.value){
    alert("Code & Name required");
    return;
  }

  fetch(`${API}?action=addProduct`
    +`&supplierId=${encodeURIComponent(SUPPLIER_ID)}`
    +`&productCode=${encodeURIComponent(pCode.value)}`
    +`&productName=${encodeURIComponent(pName.value)}`
    +`&description=${encodeURIComponent(pDesc.value)}`
    +`&sizesJSON=${encodeURIComponent(JSON.stringify(pSizes.value.split(",").map(s=>s.trim())))}`  
    +`&pricePerPC=${encodeURIComponent(pPrice.value)}`
    +`&gstPercent=${encodeURIComponent(pGST.value)}`
    +`&imageURLsJSON=${encodeURIComponent(JSON.stringify(pImages.value.split(",").map(i=>i.trim())))}`
  )
  .then(r=>r.json())
  .then(j=>{
    if(j.status!=="success"){
      alert(j.message || "Error adding product");
      return;
    }
    clearForm();
    loadProducts();
  });
}

function clearForm(){
  pCode.value=pName.value=pDesc.value=pSizes.value=pPrice.value=pGST.value=pImages.value="";
}

/* LOAD ALL PRODUCTS (FIXED) */
function loadProducts(){
  document.getElementById("list").innerHTML="Loading products…";

  fetch(`${API}?action=getProductsBySupplier&supplierId=${encodeURIComponent(SUPPLIER_ID)}&_ts=${Date.now()}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){
        document.getElementById("list").innerHTML =
          `<div class="error">${j.message || "Failed to load products"}</div>`;
        return;
      }
      products = j.data || [];
      render();
    })
    .catch(err=>{
      console.error(err);
      document.getElementById("list").innerHTML =
        "<div class='error'>Network error</div>";
    });
}

/* RENDER */
function render(){
  const q = search.value.toLowerCase();
  const el = document.getElementById("list");
  el.innerHTML="";

  const f = products.filter(p =>
    p.productCode.toLowerCase().includes(q) ||
    p.productName.toLowerCase().includes(q)
  );

  if(!f.length){
    el.innerHTML="<div class='empty'>No products</div>";
    return;
  }

  f.forEach(p=>{
    el.innerHTML+=`
      <div class="product">
        <img src="${(p.imageURLs && p.imageURLs[0]) || ""}">
        <div>
          <b>${p.productCode}</b><br>
          <small>${p.productName}</small><br>
          <small>Sizes: ${p.sizes.join(", ")}</small><br>
          <small>₹${p.pricePerPC}</small>
        </div>
        <button class="edit" disabled>Edit</button>
      </div>`;
  });
}

/* INIT */
loadProducts();
</script>

</body>
</html>
