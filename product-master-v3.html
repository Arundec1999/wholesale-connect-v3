<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Product Master</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f5f7;
  margin:0;
}
header{
  background:#fff;
  padding:18px 22px;
  border-bottom:1px solid #ddd;
  font-size:20px;
  font-weight:600;
}

/* LAYOUT */
.container{
  display:flex;
  gap:24px;
  padding:24px;
}
.left{
  width:340px;
  background:#fff;
  padding:18px;
  border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
}
.right{
  flex:1;
  background:#fff;
  padding:18px;
  border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
}

/* FORM */
h3{margin-top:0}
input, textarea, select{
  width:100%;
  padding:10px;
  margin:8px 0 14px;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:14px;
}
textarea{resize:vertical}
button{
  padding:12px;
  background:#000;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
  width:100%;
  font-size:14px;
}
button.secondary{
  background:#555;
  margin-top:8px;
}

/* TOP BAR */
.top{
  display:flex;
  gap:14px;
  align-items:center;
  margin-bottom:18px;
}
.top b{
  font-size:16px;
  white-space:nowrap;
}
.search{
  flex:1;
  padding:12px;
  font-size:15px;
}
select{
  width:220px;
}

/* PRODUCT GRID */
.products-grid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:16px;
}

/* PRODUCT CARD */
.product{
  display:flex;
  gap:16px;
  padding:16px;
  border:1px solid #e5e5e5;
  border-radius:12px;
  background:#fff;
}
.product img{
  width:100px;
  height:130px;
  object-fit:cover;
  border-radius:8px;
  background:#eee;
}
.info{
  flex:1;
}
.info b{
  font-size:15px;
}
.info small{
  display:block;
  margin-top:4px;
  color:#555;
  font-size:13px;
}
.stock{
  font-weight:600;
}
.stock.ok{color:#2e7d32}
.stock.low{color:#c62828}

/* ACTIONS */
.actions{
  display:flex;
  align-items:flex-start;
}
.actions button{
  width:80px;
  padding:8px;
  font-size:13px;
}

/* EMPTY */
.empty{
  color:#777;
  padding:30px 0;
  text-align:center;
}

/* RESPONSIVE */
@media(max-width:1100px){
  .products-grid{
    grid-template-columns:1fr;
  }
}
</style>
</head>

<body>

<header>PRODUCT MASTER</header>

<div class="container">

  <!-- LEFT PANEL -->
  <div class="left">
    <h3 id="formTitle">Add Product</h3>

    <input id="pCode" placeholder="Product Code">
    <input id="pName" placeholder="Product Name">
    <textarea id="pDesc" placeholder="Description"></textarea>
    <input id="pSizes" placeholder="Sizes (M,L,XL)">
    <input id="pPrice" placeholder="Price per PC">
    <input id="pGST" placeholder="GST %">
    <input id="pImages" placeholder="Image URLs (comma separated)">

    <button id="saveBtn" onclick="saveProduct()">Save Product</button>
    <button id="cancelBtn" class="secondary" onclick="resetForm()" style="display:none">
      Cancel Edit
    </button>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right">
    <div class="top">
      <b>All Products</b>

      <select id="sort" onchange="render()">
        <option value="latest">Latest Added</option>
        <option value="stockDesc">Stock: High → Low</option>
        <option value="priceAsc">Price: Low → High</option>
        <option value="priceDesc">Price: High → Low</option>
        <option value="nameAsc">Name: A → Z</option>
      </select>

      <input id="search" class="search" placeholder="Search product code or name" oninput="render()">
    </div>

    <div id="list" class="products-grid">Loading products…</div>
  </div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";
const SUPPLIER_ID="SUP001";

let products=[];
let editingProduct=null;

/* SAFE STOCK */
function getStock(p){
  return Number(p.availableStock || 0);
}

/* SAVE PRODUCT */
function saveProduct(){
  if(!pCode.value || !pName.value){
    alert("Product Code & Name required");
    return;
  }

  const params =
    `&supplierId=${encodeURIComponent(SUPPLIER_ID)}` +
    `&productCode=${encodeURIComponent(pCode.value)}` +
    `&productName=${encodeURIComponent(pName.value)}` +
    `&description=${encodeURIComponent(pDesc.value)}` +
    `&sizesJSON=${encodeURIComponent(JSON.stringify(pSizes.value.split(",").map(s=>s.trim())))}`
    +`&pricePerPC=${encodeURIComponent(pPrice.value)}`
    +`&gstPercent=${encodeURIComponent(pGST.value)}`
    +`&imageURLsJSON=${encodeURIComponent(JSON.stringify(pImages.value.split(",").map(i=>i.trim())))}`;

  fetch(`${API}?action=addProduct${params}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){alert(j.message);return;}
      resetForm();
      loadProducts();
    });
}

/* LOAD PRODUCTS */
function loadProducts(){
  fetch(`${API}?action=getProductsBySupplier&supplierId=${SUPPLIER_ID}&_=${Date.now()}`)
    .then(r=>r.json())
    .then(j=>{
      products=j.data||[];
      render();
    })
    .catch(()=>{
      list.innerHTML="<div class='empty'>Failed to load products</div>";
    });
}

/* RENDER */
function render(){
  const q=search.value.toLowerCase();
  const s=sort.value;

  let listData=products.filter(p =>
    String(p.productCode).toLowerCase().includes(q) ||
    String(p.productName).toLowerCase().includes(q)
  );

  if(s==="priceAsc") listData.sort((a,b)=>a.pricePerPC-b.pricePerPC);
  else if(s==="priceDesc") listData.sort((a,b)=>b.pricePerPC-a.pricePerPC);
  else if(s==="nameAsc") listData.sort((a,b)=>a.productName.localeCompare(b.productName));
  else if(s==="stockDesc") listData.sort((a,b)=>getStock(b)-getStock(a));

  const el=document.getElementById("list");
  el.innerHTML="";

  if(!listData.length){
    el.innerHTML="<div class='empty'>No products found</div>";
    return;
  }

  listData.forEach(p=>{
    const stock=getStock(p);
    const stockClass=stock>0?"ok":"low";

    el.innerHTML+=`
      <div class="product">
        <img src="${p.imageURLs?.[0]||""}">
        <div class="info">
          <b>${p.productCode}</b>
          <small>${p.productName}</small>
          <small>Sizes: ${p.sizes.join(", ")}</small>
          <small>₹${p.pricePerPC}</small>
          <small class="stock ${stockClass}">
            Available: ${stock} sets
          </small>
        </div>
        <div class="actions">
          <button disabled>Edit</button>
        </div>
      </div>`;
  });
}

/* RESET FORM */
function resetForm(){
  editingProduct=null;
  formTitle.innerText="Add Product";
  saveBtn.innerText="Save Product";
  cancelBtn.style.display="none";
  pCode.disabled=false;

  pCode.value="";
  pName.value="";
  pDesc.value="";
  pSizes.value="";
  pPrice.value="";
  pGST.value="";
  pImages.value="";
}

/* INIT */
loadProducts();
</script>

</body>
</html>
