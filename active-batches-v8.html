<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Supplier – Active Batches</title>

<style>
body{font-family:Arial;background:#f4f5f7;margin:0}
header{background:#fff;padding:14px 18px;font-size:18px;font-weight:600;border-bottom:1px solid #ddd}

.batch{background:#fff;margin:14px;border-radius:8px;border:1px solid #ddd}
.batch h3{
  margin:0;padding:12px 16px;background:#fafafa;
  border-bottom:1px solid #eee;
  display:flex;justify-content:space-between;align-items:flex-start
}

.closeWrap{display:flex;flex-direction:column;align-items:flex-end}
.closeMsg{margin-top:4px;font-size:12px;color:#c0392b;font-weight:600}

.row{
  display:grid;
  grid-template-columns:70px 1.6fr 80px 90px 90px 90px 90px 80px;
  padding:10px 16px;border-top:1px solid #eee;align-items:center;font-size:13px
}
.row.head{font-weight:bold;background:#f9f9f9}

.row img{width:55px;height:55px;object-fit:cover;border-radius:6px;border:1px solid #ddd}

.green{color:#1e8f39;font-weight:bold}
.red{color:#c0392b;font-weight:bold}
.yellow{color:#f39c12;font-weight:bold}

button{padding:4px 8px;border:1px solid #aaa;background:#fff;cursor:pointer}
button:hover{background:#eee}
button[disabled]{background:#eee;color:#aaa;cursor:not-allowed}

.buyerBox{
  background:#fafafa;margin:8px 16px 12px 16px;
  border:1px solid #ddd;border-radius:6px
}

.buyerRow{
  display:grid;
  grid-template-columns:120px 90px 90px 90px 240px;
  padding:6px 10px;font-size:12px;border-top:1px solid #eee;align-items:center
}
.buyerRow.head{font-weight:bold;background:#eee}

input.qty{width:60px;padding:3px}
</style>
</head>

<body>

<header>Active Batches</header>
<div id="batches"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";
let supplierId = localStorage.getItem("supplierId") || prompt("Enter Supplier ID");

localStorage.setItem("supplierId", supplierId);

const batchState = {};   // tracks OPEN buyers per batch

/* ================= INITIAL LOAD ================= */
function load(){
fetch(API+"?action=getSupplierActiveBatches&supplierId="+supplierId)
.then(r=>r.json())
.then(data=>{
  const wrap=document.getElementById("batches");
  wrap.innerHTML="";

  data.forEach(b=>{
    batchState[b.batchId]=0;

    const block=document.createElement("div");
    block.className="batch";

    block.innerHTML=`
      <h3>
        <span>Batch ${b.batchId}</span>
        <span class="closeWrap" id="closeWrap-${b.batchId}">
          <button disabled>Close Batch</button>
          <div class="closeMsg">Checking buyer approvals…</div>
        </span>
      </h3>

      <div class="row head">
        <div>Img</div><div>Product</div><div>Godown</div>
        <div>Locked</div><div>This Batch</div><div>Reserved</div><div>Sellable</div><div>Edit</div>
      </div>
    `;

    b.items.forEach(i=>{
      let cls=i.availableSets==0?"red":(i.availableSets<5?"yellow":"green");

      block.innerHTML+=`
      <div class="row">
        <div><img src="${i.image||'https://via.placeholder.com/55'}"></div>
        <div><b>${i.productCode}</b><br>${i.productName}</div>
        <div>${i.godown}</div>
        <div>${i.allocatedAll}</div>
        <div>${i.totalSets}</div>
        <div>${i.reservedSets}</div>
        <div class="${cls}">${i.availableSets}</div>
        <div>
          <button onclick="editStock('${b.batchId}','${i.productCode}',${i.availableSets},${i.reservedSets})">✏️</button>
        </div>
      </div>
      <div id="buyers-${b.batchId}-${i.productCode}"></div>
      `;

      loadBuyers(b.batchId,i.productCode);
    });

    wrap.appendChild(block);
  });
});
}

/* ================= LOAD BUYERS ================= */
function loadBuyers(batch,code){
 fetch(API+`?action=getReservationsForBatchProduct&batchId=${batch}&productCode=${code}`)
 .then(r=>r.json())
 .then(res=>{
  if(res.status!=="success") return;

  const div=document.getElementById(`buyers-${batch}-${code}`);
  if(!div) return;

  if(res.data.length===0){
    div.innerHTML="";
    updateClose(batch);
    return;
  }

  let h=`<div class="buyerBox">
    <div class="buyerRow head">
      <div>Buyer</div><div>Requested</div><div>Approved</div><div>Status</div><div>Action</div>
    </div>`;

  let openCount=0;

  res.data.forEach(b=>{
    if(b.status==="OPEN") openCount++;

    h+=`
    <div class="buyerRow" data-basket="${b.basketId}" data-code="${code}">
      <div>${b.buyerId}</div>
      <div>${b.requestedSets}</div>
      <div><input class="qty" id="qty-${b.basketId}-${code}" value="${b.approvedSets}"></div>
      <div class="status">${b.status}</div>
      <div>
        <button onclick="updateQty('${b.basketId}','${batch}','${code}')">Update</button>
        <button onclick="approve('${b.basketId}')">Approve</button>
        <button onclick="reject('${b.basketId}','${batch}','${code}')">Reject</button>
      </div>
    </div>`;
  });

  div.innerHTML=h+"</div>";
  batchState[batch]=openCount;
  updateClose(batch);
 });
}

/* ================= CLOSE BUTTON ================= */
function updateClose(batch){
 const wrap=document.getElementById("closeWrap-"+batch);
 if(!wrap) return;

 if(batchState[batch]>0){
   wrap.innerHTML=`
     <button disabled>Close Batch</button>
     <div class="closeMsg">Please approve or reject all buyer requests to close this batch.</div>`;
 }else{
   wrap.innerHTML=`<button onclick="closeBatch('${batch}')">Close Batch</button>`;
 }
}

/* ================= LIVE REFRESH (NO FLICKER) ================= */
function refreshBuyers(){
  document.querySelectorAll("[id^='buyers-']").forEach(div=>{
    const [batch, code] = div.id.replace("buyers-","").split("-");
    loadBuyers(batch, code);
  });
}

/* ================= ACTIONS ================= */
function editStock(batch,code,avail,res){
 const v=prompt("New SELLABLE sets",avail);
 if(v==null) return;
 if(v<res) return alert("Below reserved");
 fetch(API+`?action=updateBatchAvailable&batchId=${batch}&productCode=${code}&newAvailable=${v}`).then(load);
}

function updateQty(basket,batch,code){
 const v=Number(document.getElementById(`qty-${basket}-${code}`).value);
 fetch(API+`?action=updateBasketItemQty&basketId=${basket}&batchId=${batch}&productCode=${code}&sets=${v}`).then(refreshBuyers);
}

function approve(id){ fetch(API+"?action=approveBasket&basketId="+id).then(refreshBuyers); }
function reject(id,batch,code){ fetch(API+`?action=rejectBasketItem&basketId=${id}&batchId=${batch}&productCode=${code}`).then(refreshBuyers); }

function closeBatch(id){
 if(!confirm("Close this batch?")) return;
 fetch(API+"?action=closeBatch&batchId="+id).then(load);
}

/* INIT */
load();
setInterval(refreshBuyers, 10000);
</script>

</body>
</html>
