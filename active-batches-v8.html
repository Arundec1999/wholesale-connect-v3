<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Supplier – Active Batches</title>

<style>
body{font-family:Arial;background:#f4f5f7;margin:0}
header{background:#fff;padding:14px 18px;font-size:18px;font-weight:600;border-bottom:1px solid #ddd}
.batch{background:#fff;margin:14px;border-radius:8px;border:1px solid #ddd}
.batch h3{
  margin:0;padding:12px 16px;background:#fafafa;
  border-bottom:1px solid #eee;
  display:flex;justify-content:space-between;align-items:flex-start
}
.closeWrap{display:flex;flex-direction:column;align-items:flex-end}
.closeMsg{margin-top:4px;font-size:12px;color:#c0392b;font-weight:600}

.row{
  display:grid;
  grid-template-columns:70px 1.6fr 80px 90px 90px 90px 90px 80px;
  padding:10px 16px;border-top:1px solid #eee;align-items:center;font-size:13px
}
.row.head{font-weight:bold;background:#f9f9f9}
.row img{width:55px;height:55px;object-fit:cover;border-radius:6px;border:1px solid #ddd}

button{padding:4px 8px;border:1px solid #aaa;background:#fff;cursor:pointer}
button[disabled]{background:#eee;color:#aaa}

.buyerBox{background:#fafafa;margin:8px 16px 12px;border:1px solid #ddd;border-radius:6px}
.buyerRow{
  display:grid;
  grid-template-columns:120px 90px 90px 90px 240px;
  padding:6px 10px;font-size:12px;border-top:1px solid #eee;align-items:center
}
.buyerRow.head{font-weight:bold;background:#eee}
input.qty{width:60px;padding:3px}
</style>
</head>

<body>

<header>Active Batches</header>
<div id="batches"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";
let supplierId=localStorage.getItem("supplierId")||prompt("Enter Supplier ID");
localStorage.setItem("supplierId",supplierId);

let editingInput=null;
document.addEventListener("focusin",e=>{ if(e.target.classList.contains("qty")) editingInput=e.target.id; });
document.addEventListener("focusout",()=> editingInput=null);

/* ---------- INITIAL LOAD ---------- */
fetch(API+"?action=getSupplierActiveBatches&supplierId="+supplierId)
.then(r=>r.json()).then(drawPage);

/* ---------- DRAW ---------- */
function drawPage(data){
  const wrap=document.getElementById("batches");
  wrap.innerHTML="";

  data.forEach(b=>{
    const block=document.createElement("div");
    block.className="batch";
    block.id="batch-"+b.batchId;

    block.innerHTML=`
      <h3>
        <span>Batch ${b.batchId}</span>
        <span class="closeWrap" id="closeWrap-${b.batchId}"></span>
      </h3>
      <div class="row head">
        <div>Img</div><div>Product</div><div>Godown</div>
        <div>Locked</div><div>This Batch</div><div>Reserved</div><div>Sellable</div><div>Edit</div>
      </div>`;

    b.items.forEach(i=>{
      block.innerHTML+=`
      <div class="row" id="row-${b.batchId}-${i.productCode}">
        <div><img src="${i.image||''}"></div>
        <div><b>${i.productCode}</b><br>${i.productName}</div>
        <div class="godown">${i.godown}</div>
        <div class="locked">${i.allocatedAll}</div>
        <div class="total">${i.totalSets}</div>
        <div class="reserved">${i.reservedSets}</div>
        <div class="available">${i.availableSets}</div>
        <div><button onclick="editSellable('${b.batchId}','${i.productCode}')">✏️</button></div>
      </div>
      <div id="buyers-${b.batchId}-${i.productCode}"></div>`;
    });

    wrap.appendChild(block);
  });

  refresh();
}

/* ---------- REFRESH ---------- */
setInterval(refresh,8000);

function refresh(){
 fetch(API+"?action=getSupplierActiveBatches&supplierId="+supplierId)
 .then(r=>r.json()).then(updatePage);
}

function updatePage(data){
 data.forEach(b=>{
  let hasOpen=false;

  const promises = b.items.map(i=>{
    const row=document.getElementById(`row-${b.batchId}-${i.productCode}`);
    if(!row) return Promise.resolve(false);

    row.querySelector(".reserved").innerText=i.reservedSets;
    row.querySelector(".available").innerText=i.availableSets;
    row.querySelector(".total").innerText=i.totalSets;

    return loadBuyers(b.batchId,i.productCode);
  });

  Promise.all(promises).then(flags=>{
    flags.forEach(f=>{ if(f) hasOpen=true; });
    updateClose(b.batchId,hasOpen);
  });
 });
}

/* ---------- BUYERS ---------- */
function loadBuyers(batch,code){
 return fetch(API+`?action=getReservationsForBatchProduct&batchId=${batch}&productCode=${code}`)
 .then(r=>r.json()).then(res=>{
  const div=document.getElementById(`buyers-${batch}-${code}`);
  if(res.data.length===0){div.innerHTML="";return false;}

  let open=false;
  let h=`<div class="buyerBox">
  <div class="buyerRow head"><div>Buyer</div><div>Req</div><div>Appr</div><div>Status</div><div>Action</div></div>`;

  res.data.forEach(b=>{
    if(b.status==="OPEN") open=true;
    const id=`qty-${b.basketId}-${code}`;
    const val = (editingInput===id) ? document.getElementById(id)?.value : b.approvedSets;

    h+=`
    <div class="buyerRow">
      <div>${b.buyerId}</div>
      <div>${b.requestedSets}</div>
      <div><input class="qty" id="${id}" value="${val}"></div>
      <div>${b.status}</div>
      <div>
        <button onclick="updateQty('${b.basketId}','${batch}','${code}')">Update</button>
        <button onclick="approve('${b.basketId}')">Approve</button>
        <button onclick="reject('${b.basketId}','${batch}','${code}')">Reject</button>
      </div>
    </div>`;
  });

  div.innerHTML=h+"</div>";
  return open;
 });
}

/* ---------- CLOSE ---------- */
function updateClose(batch,hasOpen){
 const wrap=document.getElementById("closeWrap-"+batch);
 if(hasOpen){
   wrap.innerHTML=`<button disabled>Close Batch</button>
   <div class="closeMsg">Please approve or reject all buyer requests to close this batch.</div>`;
 }else{
   wrap.innerHTML=`<button onclick="closeBatch('${batch}')">Close Batch</button>`;
 }
}

/* ---------- ACTIONS ---------- */
function editSellable(batch, code){
  const v = prompt("New SELLABLE sets");
  if(v===null) return;
  fetch(API+`?action=updateBatchAvailable&batchId=${batch}&productCode=${code}&newAvailable=${v}`).then(refresh);
}
function updateQty(b,batch,code){
 fetch(API+`?action=updateBasketItemQty&basketId=${b}&batchId=${batch}&productCode=${code}&sets=${document.getElementById('qty-'+b+'-'+code).value}`)
 .then(()=>refresh);
}
function approve(id){fetch(API+"?action=approveBasket&basketId="+id).then(refresh);}
function reject(id,batch,code){
 if(!confirm("Reject this buyer and return their reserved stock?\nThis cannot be undone.")) return;
 fetch(API+`?action=rejectBasketItem&basketId=${id}&batchId=${batch}&productCode=${code}`).then(refresh);
}
function closeBatch(id){
 if(!confirm("Close this batch?\nUnsold stock will return to godown.")) return;
 fetch(API+"?action=closeBatch&batchId="+id).then(()=>location.reload());
}
</script>

</body>
</html>
