<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stock Updates to Customers</title>

<style>
body{font-family:Arial,sans-serif;background:#f4f5f7;margin:0}
header{background:#fff;padding:18px 22px;border-bottom:1px solid #ddd;font-size:20px;font-weight:600}

.container{
  display:grid;
  grid-template-columns:1fr 360px 1fr;
  gap:24px;
  padding:24px
}

.panel{
  background:#fff;
  padding:18px;
  border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,.06)
}
.panel h3{margin-top:0;font-size:16px}

.top{display:flex;gap:10px;margin-bottom:14px}
.top input{flex:1}

input{
  width:100%;
  padding:10px;
  margin-top:6px;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:14px
}

button{
  padding:10px;
  background:#000;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  width:100%;
}
button.small{padding:6px 10px;font-size:12px;width:auto}
button.warn{background:#c62828}

.products{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px
}
.product{
  display:flex;
  gap:10px;
  padding:10px;
  border:1px solid #e5e5e5;
  border-radius:10px
}
.product small{display:block;color:#555;font-size:12px}

.stock.ok{color:#2e7d32;font-weight:600}
.stock.low{color:#c62828;font-weight:600}

.batch-box{
  background:#fff8c4;
  padding:12px;
  border-radius:8px;
  font-size:14px;
  margin-bottom:16px
}

.hidden{display:none}

@media(max-width:1200px){
  .products{grid-template-columns:1fr}
}
</style>
</head>

<body>

<header>STOCK UPDATES TO CUSTOMERS</header>

<div class="container">

<!-- LEFT: PRODUCTS -->
<div class="panel">
  <h3>Products (Godown / Allocated / Available)</h3>

  <div class="top">
    <input id="search" placeholder="Search product" oninput="renderProducts()">
  </div>

  <div id="productList" class="products">Loading products…</div>
</div>

<!-- CENTER: BATCH CONTROL -->
<div class="panel">
  <h3>Batch Control</h3>

  <!-- NO BATCH -->
  <div id="noBatch">
    <button onclick="startBatch()">Start Batch</button>
  </div>

  <!-- BATCH RUNNING -->
  <div id="batchRunning" class="hidden">
    <div class="batch-box">
      <b>Batch Running</b><br>
      Batch ID: <span id="batchIdText"></span><br>
      Started at: <span id="batchTimeText"></span><br>
      Supplier: SUP001
    </div>

    <label>Product Code</label>
    <input id="batchProductCode" placeholder="Select from left">

    <label>Sets to allocate</label>
    <input id="batchSets" placeholder="Number of sets">

    <button onclick="addProductToBatch()">Add to Batch</button>

    <button class="warn" style="margin-top:14px"
      onclick="closeCurrentBatch()">
      Close Batch & Return Unsold Stock
    </button>
  </div>
</div>

<!-- RIGHT: CURRENT BATCH -->
<div class="panel">
  <h3>Current Batch</h3>
  <div id="batchItems" style="font-size:14px;color:#777">
    No active batch
  </div>

  <button style="margin-top:16px" onclick="publishBatch()">
    Publish Batch
  </button>
</div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";
const SUPPLIER_ID="SUP001";

let products=[];
let batchId=null;
let batchStartTime=null;

/* ---------- LOAD PRODUCTS ---------- */
function loadProducts(){
  productList.innerHTML="Loading products…";

  fetch(`${API}?action=getProductStockSummary&supplierId=${SUPPLIER_ID}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){
        productList.innerHTML="Failed to load products";
        alert(j.message);
        return;
      }
      products=j.data||[];
      renderProducts();
    })
    .catch(()=>{
      productList.innerHTML="Backend not reachable";
    });
}

/* ---------- RENDER PRODUCTS ---------- */
function renderProducts(){
  const q=search.value.toLowerCase();
  const list=products.filter(p=>
    String(p.productCode).toLowerCase().includes(q) ||
    String(p.productName).toLowerCase().includes(q)
  );

  productList.innerHTML="";
  if(!list.length){
    productList.innerHTML="<div style='color:#777'>No products</div>";
    return;
  }

  list.forEach(p=>{
    const available=Math.max(0,p.availableToAllocate);

    productList.innerHTML+=`
      <div class="product">
        <div style="flex:1">
          <b>${p.productCode}</b>
          <small>${p.productName}</small>
          <small>Godown: ${p.masterStock}</small>
          <small>Allocated: ${p.allocatedStock}</small>
          <small class="stock ${available>0?'ok':'low'}">
            Available: ${available}
          </small>
        </div>
        <div>
          <button class="small"
            onclick="selectForBatch('${p.productCode}',${available})"
            ${available<=0?'disabled':''}>
            Add
          </button>
        </div>
      </div>`;
  });
}

/* ---------- START BATCH ---------- */
function startBatch(){
  fetch(`${API}?action=startBatch&supplierId=${SUPPLIER_ID}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){ alert(j.message); return; }

      batchId=j.data.batchId;
      batchStartTime=new Date();

      noBatch.classList.add("hidden");
      batchRunning.classList.remove("hidden");

      batchIdText.innerText=batchId;
      batchTimeText.innerText=batchStartTime.toLocaleString();

      batchItems.innerHTML="Batch started. Add products from left.";
    });
}

/* ---------- SELECT PRODUCT ---------- */
function selectForBatch(code,max){
  if(!batchId){ alert("Start batch first"); return; }
  batchProductCode.value=code;
  batchSets.value="";
  batchSets.max=max;
  batchSets.focus();
}

/* ---------- ADD PRODUCT TO BATCH ---------- */
function addProductToBatch(){
  if(!batchId) return;

  const code=batchProductCode.value.trim();
  const sets=Number(batchSets.value);

  if(!code || isNaN(sets) || sets<=0){
    alert("Valid product & sets required");
    return;
  }

  fetch(`${API}?action=addProductToBatch`
    +`&batchId=${encodeURIComponent(batchId)}`
    +`&productCode=${encodeURIComponent(code)}`
    +`&totalSets=${sets}`
  )
  .then(r=>r.json())
  .then(j=>{
    if(j.status!=="success"){ alert(j.message); return; }

    batchProductCode.value="";
    batchSets.value="";

    loadBatchItems();
    loadProducts();
  });
}

/* ---------- LOAD BATCH ITEMS ---------- */
function loadBatchItems(){
  if(!batchId){
    batchItems.innerHTML="No active batch";
    return;
  }

  fetch(`${API}?action=getBatchItems&batchId=${batchId}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){
        batchItems.innerHTML="Failed to load batch items";
        return;
      }
      renderBatchItems(j.data||[]);
    });
}

/* ---------- RENDER BATCH ITEMS ---------- */
function renderBatchItems(items){
  if(!items.length){
    batchItems.innerHTML="No products added yet";
    return;
  }

  batchItems.innerHTML="";
  items.forEach(p=>{
    batchItems.innerHTML+=`
      <div class="product">
        <div style="flex:1">
          <b>${p.productCode}</b>
          <small>${p.productName}</small>
          <small>Sets in batch: ${p.sets}</small>
          <small>Available in batch: ${p.availableSets}</small>
          <small>₹${p.pricePerPC}</small>
        </div>
      </div>
    `;
  });
}

/* ---------- CLOSE BATCH ---------- */
function closeCurrentBatch(){
  if(!batchId) return;

  if(!confirm(
    "Closing batch will:\n\n• Remove it from buyers\n• Return UNSOLD stock to godown\n\nProceed?"
  )) return;

  fetch(`${API}?action=closeBatch&batchId=${batchId}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){ alert(j.message); return; }

      alert("Batch closed. Unsold stock returned.");

      batchId=null;
      batchRunning.classList.add("hidden");
      noBatch.classList.remove("hidden");
      batchItems.innerHTML="Batch closed.";
      loadProducts();
    });
}

/* ---------- PUBLISH BATCH ---------- */
function publishBatch(){
  if(!batchId){ alert("No batch running"); return; }

  if(!confirm("Publish this batch to buyers?")) return;

  fetch(`${API}?action=publishBatch&batchId=${batchId}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=="success"){ alert(j.message); return; }

      alert("Batch published");
    });
}

/* INIT */
loadProducts();
</script>

</body>
</html>
