<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Product Master</title>

<style>
body{font-family:Arial;background:#f4f5f7;margin:0}
header{background:#fff;padding:16px 20px;border-bottom:1px solid #ddd;font-size:20px;font-weight:600}

.container{display:flex;gap:20px;padding:20px}
.left{width:360px;background:#fff;padding:16px;border-radius:10px}
.right{flex:1;background:#fff;padding:16px;border-radius:10px}

input,textarea,select{
  width:100%;
  padding:9px;
  margin:6px 0 12px;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:14px
}

button{
  padding:8px 12px;
  background:#000;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px
}

.top{
  display:flex;
  gap:10px;
  align-items:center;
  margin-bottom:14px
}

.products{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:14px
}

.product{
  display:flex;
  gap:12px;
  padding:12px;
  border:1px solid #e5e5e5;
  border-radius:10px
}
.product img{
  width:70px;height:90px;
  object-fit:cover;
  border-radius:6px;
  background:#eee
}
.product small{display:block;color:#555;font-size:12px}

.stock{font-weight:600;margin-top:4px}
.stock.ok{color:#2e7d32}
.stock.low{color:#c62828}

.edit-box{display:none;margin-top:10px}
.edit-actions{margin-top:8px}
</style>
</head>

<body>

<header>PRODUCT MASTER</header>

<div class="container">

  <!-- ADD PRODUCT -->
  <div class="left">
    <h3>Add Product</h3>

    <input id="pCode" placeholder="Product Code">
    <input id="pName" placeholder="Product Name">
    <textarea id="pDesc" placeholder="Description"></textarea>
    <input id="pSizes" placeholder="Sizes (M,L,XL)">
    <input id="pPrice" placeholder="Price per PC">
    <input id="pGST" placeholder="GST %">
    <input id="pStock" placeholder="Master Stock (sets)">
    <input id="pImages" placeholder="Image URLs (comma separated)">

    <button onclick="addProduct()">Save Product</button>
  </div>

  <!-- ALL PRODUCTS -->
  <div class="right">
    <div class="top">
      <input id="search" placeholder="Search" oninput="render()">

      <select id="sort" onchange="render()">
        <option value="latest">Latest added</option>
        <option value="stockHigh">Stock: High → Low</option>
        <option value="stockLow">Stock: Low → High</option>
        <option value="name">Product Name A–Z</option>
      </select>
    </div>

    <div id="list" class="products">Loading products…</div>
  </div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";
const SUPPLIER_ID="SUP001";
let products=[];

/* LOAD PRODUCTS */
function loadProducts(){
  fetch(`${API}?action=getProductsBySupplier&supplierId=${SUPPLIER_ID}`)
    .then(r=>r.json())
    .then(j=>{
      products = j.data || [];
      render();
    });
}

/* RENDER */
function render(){
  const q = search.value.toLowerCase();
  const sortVal = sort.value;

  let listData = products.filter(p =>
    String(p.productCode).toLowerCase().includes(q) ||
    String(p.productName).toLowerCase().includes(q)
  );

  if(sortVal==="latest"){
    listData.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  }
  if(sortVal==="stockHigh"){
    listData.sort((a,b)=>getStock(b)-getStock(a));
  }
  if(sortVal==="stockLow"){
    listData.sort((a,b)=>getStock(a)-getStock(b));
  }
  if(sortVal==="name"){
    listData.sort((a,b)=>a.productName.localeCompare(b.productName));
  }

  list.innerHTML="";
  if(!listData.length){
    list.innerHTML="<div style='color:#777'>No products</div>";
    return;
  }

  listData.forEach(p=>{
    const stock = getStock(p);
    list.innerHTML+=`
      <div class="product">
        <img src="${p.imageURLs?.[0]||""}">
        <div style="flex:1">
          <b>${p.productCode}</b>
          <small>${p.productName}</small>
          <small>Sizes: ${p.sizes.join(", ")}</small>
          <small>₹${p.pricePerPC}</small>
          <div class="stock ${stock>0?'ok':'low'}">
            Godown Stock: ${stock} sets
          </div>

          <div class="edit-actions">
            <button onclick="openEdit('${p.productCode}')">Edit</button>
          </div>

          <div class="edit-box" id="edit-${p.productCode}">
            <input id="eName-${p.productCode}" value="${p.productName}">
            <textarea id="eDesc-${p.productCode}">${p.description||""}</textarea>
            <input id="eSizes-${p.productCode}" value="${p.sizes.join(",")}">
            <input id="ePrice-${p.productCode}" value="${p.pricePerPC}">
            <input id="eGST-${p.productCode}" value="${p.gstPercent}">
            <input id="eStock-${p.productCode}" value="${stock}">
            <input id="eImages-${p.productCode}" value="${(p.imageURLs||[]).join(",")}">

            <button onclick="saveEdit('${p.productCode}')">Save</button>
            <button onclick="closeEdit('${p.productCode}')">Cancel</button>
          </div>
        </div>
      </div>`;
  });
}

/* HELPERS */
function getStock(p){
  return Number(p.MASTER_STOCK ?? p.masterStock ?? 0);
}

function openEdit(code){
  document.getElementById(`edit-${code}`).style.display="block";
}
function closeEdit(code){
  document.getElementById(`edit-${code}`).style.display="none";
}

/* SAVE EDIT (frontend wired, backend next step) */
function saveEdit(code){
  alert("Frontend wired. Next step: backend updateProduct API.");
}

/* ADD PRODUCT */
function addProduct(){
  fetch(`${API}?action=addProduct`
    +`&supplierId=${SUPPLIER_ID}`
    +`&productCode=${pCode.value}`
    +`&productName=${pName.value}`
    +`&description=${pDesc.value}`
    +`&sizesJSON=${JSON.stringify(pSizes.value.split(",").map(s=>s.trim()))}`
    +`&pricePerPC=${pPrice.value}`
    +`&gstPercent=${pGST.value}`
    +`&imageURLsJSON=${JSON.stringify(pImages.value.split(",").map(i=>i.trim()))}`
    +`&masterStock=${pStock.value}`
  ).then(()=>{ loadProducts(); });
}

/* INIT */
loadProducts();
</script>

</body>
</html>
