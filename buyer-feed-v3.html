<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Buyer Feed</title>
<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
header{background:#fff;padding:12px;border-bottom:1px solid #ddd}
.batch{padding:12px}
.card{background:#fff;padding:10px;margin-top:8px;display:flex;gap:10px}
img{width:70px;height:90px;object-fit:cover}
</style>
</head>

<body>
<header><b>Stock Updates</b></header>
<div id="feed"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";
const BUYER_ID="BUY001";
const SUPPLIER_ID="SUP001";

fetch(`${API}?action=getSupplierUpdates&supplierId=${SUPPLIER_ID}`)
.then(r=>r.json()).then(j=>{
j.data.forEach(b=>{
const d=document.createElement("div");
d.className="batch";
d.innerHTML=`<small>${new Date(b.batchTime).toLocaleString()}</small>`;
b.products.forEach(p=>{
d.innerHTML+=`
<div class="card">
<img src="${p.imageURLs[0]||''}">
<div>
<b>${p.productName}</b><br>
${p.description}<br>
Sizes: ${p.sizes.join(", ")}<br>
â‚¹${p.pricePerPC}+${p.gstPercent}% GST<br>
<button onclick="add('${b.batchId}','${p.productCode}')">Add</button>
</div></div>`;
});
feed.appendChild(d);
});
});

function add(batchId, productCode){

  const s = prompt("Enter number of sets");

  if (!s || isNaN(s) || Number(s) <= 0) {
    alert("Invalid sets value");
    return;
  }

  const url =
    `${API}?action=addToBasket`
    + `&buyerId=${encodeURIComponent(BUYER_ID)}`
    + `&supplierId=${encodeURIComponent(SUPPLIER_ID)}`
    + `&batchId=${encodeURIComponent(batchId)}`
    + `&productCode=${encodeURIComponent(productCode)}`
    + `&sets=${encodeURIComponent(s)}`;

  fetch(url)
    .then(r => r.json())
    .then(j => {
      if (j.status !== "success") {
        alert("Error: " + j.message);
        return;
      }
      alert("Added to basket");
    })
    .catch(err => {
      alert("Network error");
      console.error(err);
    });
}
