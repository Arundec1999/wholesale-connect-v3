<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Buyer – Stock Feed</title>

<style>
body{
  font-family: Arial;
  background:#f5f5f5;
  margin:0;
}
header{
  background:#fff;
  padding:12px;
  border-bottom:1px solid #ddd;
}
.batch{
  padding:12px;
}
.card{
  background:#fff;
  padding:10px;
  margin-top:8px;
  display:flex;
  gap:10px;
  border-radius:6px;
}
img{
  width:70px;
  height:90px;
  object-fit:cover;
  border-radius:4px;
}
button{
  margin-top:6px;
  padding:6px 10px;
  background:#000;
  color:#fff;
  border:none;
  cursor:pointer;
}
small{
  color:#555;
}
</style>
</head>

<body>

<header>
  <b>Stock Updates</b>
</header>

<div id="feed">Loading stock…</div>

<script>
/* ================= CONFIG ================= */
const API =
  "https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";

const BUYER_ID = "BUY001";
const SUPPLIER_ID = "SUP001";

/* ================= LOAD FEED ================= */
fetch(`${API}?action=getSupplierUpdates&supplierId=${encodeURIComponent(SUPPLIER_ID)}`)
  .then(r => r.json())
  .then(j => {
    if (j.status !== "success") {
      document.getElementById("feed").innerText = j.message || "Failed to load";
      return;
    }
    renderFeed(j.data || []);
  })
  .catch(err => {
    console.error(err);
    document.getElementById("feed").innerText = "Network error";
  });

/* ================= RENDER ================= */
function renderFeed(batches){
  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  if (!batches.length) {
    feed.innerHTML = "<small>No stock available</small>";
    return;
  }

  batches.forEach(b => {
    const d = document.createElement("div");
    d.className = "batch";

    d.innerHTML = `<small>${new Date(b.batchTime).toLocaleString()}</small>`;

    b.products.forEach(p => {
      d.innerHTML += `
        <div class="card">
          <img src="${p.imageURLs[0] || ""}">
          <div>
            <b>${p.productName}</b><br>
            <small>${p.description || ""}</small><br>
            <small>Sizes: ${p.sizes.join(", ")}</small><br>
            <small>₹${p.pricePerPC} + ${p.gstPercent}% GST</small><br>
            <small>Available Sets: ${p.availableSets}</small><br>

            <button onclick="addToBasket('${b.batchId}','${p.productCode}')">
              Add to Basket
            </button>
          </div>
        </div>
      `;
    });

    feed.appendChild(d);
  });
}

/* ================= ADD TO BASKET (FIXED) ================= */
function addToBasket(batchId, productCode){

  const s = prompt("Enter number of sets");

  if (!s || isNaN(s) || Number(s) <= 0) {
    alert("Invalid sets value");
    return;
  }

  const url =
    `${API}?action=addToBasket`
    + `&buyerId=${encodeURIComponent(BUYER_ID)}`
    + `&supplierId=${encodeURIComponent(SUPPLIER_ID)}`
    + `&batchId=${encodeURIComponent(batchId)}`
    + `&productCode=${encodeURIComponent(productCode)}`
    + `&sets=${encodeURIComponent(s)}`;

  fetch(url)
    .then(r => r.json())
    .then(j => {
      if (j.status !== "success") {
        alert("Error: " + j.message);
        return;
      }
      alert("Added to basket successfully");
    })
    .catch(err => {
      console.error(err);
      alert("Network error");
    });
}
</script>

</body>
</html>
