<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Supplier ‚Äì Active Batches</title>

<style>
body{font-family:Arial;background:#f4f5f7;margin:0}
header{background:#fff;padding:14px 18px;font-size:18px;font-weight:600;border-bottom:1px solid #ddd}
.batch{background:#fff;margin:14px;border-radius:8px;border:1px solid #ddd}
.batch h3{margin:0;padding:12px 16px;background:#fafafa;border-bottom:1px solid #eee;font-size:15px}
.row{display:grid;grid-template-columns:70px 1.6fr 70px 110px 80px 80px 80px 90px 90px;padding:10px 16px;align-items:center;font-size:13px;border-top:1px solid #eee}
.row.head{font-weight:bold;background:#f9f9f9}
.row img{width:55px;height:55px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
.green{color:#1e8f39;font-weight:bold}
.yellow{color:#f39c12;font-weight:bold}
.red{color:#c0392b;font-weight:bold}
button{padding:5px 8px;border:1px solid #aaa;background:#fff;cursor:pointer}
button:hover{background:#eee}
.empty{padding:40px;text-align:center;color:#777}
</style>

</head>
<body>

<header>Active Batches</header>
<div id="batches"></div>

<script>
let supplierId = localStorage.getItem("supplierId") || prompt("Enter Supplier ID");
localStorage.setItem("supplierId",supplierId);

const API="https://script.google.com/macros/s/AKfycbyBWZeeZbMCpSaOcXeGzXc1o3HMGfko8n2YI4Veu2Ru2CQtyOKN6JNmJMt6ueqBrxxo/exec";

function loadBatches(){
fetch(API+"?action=getSupplierActiveBatches&supplierId="+encodeURIComponent(supplierId))
.then(r=>r.json())
.then(data=>{
const wrap=document.getElementById("batches");
wrap.innerHTML="";
if(!Array.isArray(data)) return wrap.innerHTML="<div class='empty'>"+JSON.stringify(data)+"</div>";
if(data.length===0) return wrap.innerHTML="<div class='empty'>No active batches</div>";

data.forEach(b=>{
const box=document.createElement("div");
box.className="batch";
box.innerHTML=`<h3>Batch ${b.batchId} ‚Äî ${new Date(b.createdAt).toLocaleString()}
<button style="float:right" onclick="closeBatch('${b.batchId}')">üõë Close</button></h3>
<div class="row head">
<div>Image</div><div>Product</div><div>Godown</div><div>Locked (All)</div><div>This Batch</div>
<div>Reserved</div><div>Sellable</div><div>Free Stock</div><div>Action</div></div>`;

(b.items||[]).forEach(i=>{
let cls=i.availableSets==0?"red":(i.availableSets<5?"yellow":"green");

box.innerHTML+=`
<div class="row">
<div><img src="${i.image||'https://via.placeholder.com/55'}"></div>
<div><b>${i.productCode}</b><br><small>${i.productName}</small></div>
<div>${i.godown}</div>
<div>${i.allocatedAll}</div>
<div>${i.totalSets}</div>
<div>${i.reservedSets}</div>
<div class="${cls}">${i.availableSets}</div>
<div>${i.availableForAllocation}</div>
<div><button onclick="editSellable('${b.batchId}','${i.productCode}',${i.availableSets},${i.reservedSets},${i.availableForAllocation})">‚úèÔ∏è</button></div>
</div>`;
});

wrap.appendChild(box);
});
});
}

function editSellable(batchId,productCode,current,reserved,free){
const v=prompt(`Sellable sets (customers can buy)\nReserved: ${reserved}\nFree in godown: ${free}`,current);
if(v===null) return;
const n=Number(v);
if(isNaN(n)||n<reserved) return alert("Invalid value");

fetch(API+"?action=updateBatchAvailable&batchId="+batchId+"&productCode="+productCode+"&newAvailable="+n)
.then(r=>r.json())
.then(res=>res.status==="success"?loadBatches():alert(res.message));
}

function closeBatch(id){
if(!confirm("Close this batch?"))return;
fetch(API+"?action=closeBatch&batchId="+id)
.then(r=>r.json()).then(res=>res.status==="success"?loadBatches():alert(res.message));
}

loadBatches();
</script>
</body>
</html>
