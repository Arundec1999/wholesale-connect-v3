<script>
let supplierId = localStorage.getItem("supplierId");
if(!supplierId){
  supplierId = prompt("Enter Supplier ID");
  localStorage.setItem("supplierId", supplierId);
}

const API = "https://script.google.com/macros/s/AKfycbzOutSpXzb0zfR5ZkJ1iq-1a1m4WImhpvn26M5oMxXzTb9J28o2rJWRG26IA2dEV3us/exec";

fetch(API + "?action=getSupplierActiveBatches&supplierId=" + supplierId)
  .then(r => r.json())
  .then(data => {

    console.log("API Response:", data);

    const wrap = document.getElementById("batches");

    if(!Array.isArray(data)){
      wrap.innerHTML = "<div style='padding:20px;color:red'>API Error: " + JSON.stringify(data) + "</div>";
      return;
    }

    if(data.length === 0){
      wrap.innerHTML = "<div style='padding:20px'>No active batches</div>";
      return;
    }

    data.forEach(b => {
      const block = document.createElement("div");
      block.className = "batch";

      const date = new Date(b.createdAt).toLocaleString();

      block.innerHTML = `
        <h3>Batch ${b.batchId} â€” ${date}</h3>
        <div class="row head">
          <div>Image</div>
          <div>Product</div>
          <div>Godown</div>
          <div>In Batch</div>
          <div>Reserved</div>
          <div>Available</div>
          <div>Load %</div>
        </div>
      `;

      const grouped = {};

      b.items.forEach(i => {
        if(!grouped[i.productCode]){
          grouped[i.productCode] = {...i};
        }else{
          grouped[i.productCode].totalSets += i.totalSets;
          grouped[i.productCode].reservedSets += i.reservedSets;
          grouped[i.productCode].availableSets += i.availableSets;
        }
      });

      Object.values(grouped).forEach(i => {
        const load = i.totalSets ? Math.round((i.reservedSets / i.totalSets) * 100) : 0;

        let cls = "green";
        if(i.availableSets === 0) cls = "red";
        else if(i.availableSets < 5) cls = "yellow";

        block.innerHTML += `
          <div class="row">
            <div><img src="${i.image || 'https://via.placeholder.com/55'}"></div>
            <div>${i.productName}</div>
            <div>${i.godown}</div>
            <div>${i.totalSets}</div>
            <div>${i.reservedSets}</div>
            <div class="${cls}">${i.availableSets}</div>
            <div>${load}%</div>
          </div>
        `;
      });

      wrap.appendChild(block);
    });

  })
  .catch(err => {
    document.getElementById("batches").innerHTML =
      "<div style='padding:20px;color:red'>JS Error: " + err + "</div>";
  });
</script>
